- name: Create user webappi
  user:
    name: webappi
    shell: /bin/bash
    state: present

- name: Create web root directory
  file:
    path: /opt/static-sites
    state: directory
    owner: webapp
    group: webapp
    mode: '0755'

- name: Install NGINX
  apt:
    name: nginx
    state: present
    update_cache: yes

- name: Ensure NGINX is running
  service:
    name: nginx
    state: started
    enabled: true

# - name: Copy index.html
#   template:
#     src: index.html.j2
#     dest: /opt/static-sites/index.html
#   notify: restart nginx

# - name: Set ownership of index.html
#   file:
#     path: /opt/static-sites/index.html
#     owner: webapp
#     group: webapp
#     mode: '0644'

- name: Deploy custom NGINX config
  template:
    src: nginx.conf.j2
    dest: /etc/nginx/sites-available/default
  notify: restart nginx

- name: Deploy main NGINX config (runs as webapp)
  template:
    src: nginx.conf.j2
    dest: /etc/nginx/nginx.conf
  notify: restart nginx

- name: Validate HTTP response from web server
  uri:
    url: http://localhost
    return_content: yes
    status_code: 200
  register: http_response

- name: Fail if expected content is missing
  fail:
    msg: "Web server did not return expected content!"
  when: "'Hello from GitHub!' not in http_response.content"

- name: Clone static site from GitHub
  git:
    repo: 'https://github.com/Miska296/static-web-test.git'
    dest: /opt/static-sites
    version: main
    force: yes
